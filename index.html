<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KOLILINK - Simulateur Connecté</title>

    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- CHART.JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- FONTS -->
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">

    <!-- SUPABASE -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --bg-dark: #0F172A;
            --accent: #3B82F6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8FAFC;
            color: #334155;
            overflow-x: hidden;
        }

        h1,
        h2,
        h3,
        .font-display {
            font-family: 'Space Grotesk', sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #CBD5E1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94A3B8;
        }

        /* Inputs Modernes & Stables */
        .input-dark {
            background: #1E293B;
            /* Slate 800 */
            border: 1px solid #334155;
            color: white;
            transition: all 0.2s;
        }

        .input-dark:focus {
            background: #0F172A;
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 2px rgba(148, 163, 184, 0.2);
        }

        /* Bouton "Lancer" animé */
        .btn-pulse {
            animation: pulse-border 3s infinite;
        }

        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(59, 130, 246, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        /* Overlay de chargement */
        .loading-overlay {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            z-index: 50;
        }

        /* --- PRINT SPECIFICS : OPTIMISATION PLEINE PAGE --- */
        @media print {

            /* 1. Marges zéro pour utiliser toute la feuille */
            @page {
                margin: 0;
                size: A4 portrait;
            }

            /* 2. Reset Global */
            body,
            html {
                height: 100% !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: hidden !important;
                background: white !important;
                color: black !important;
                -webkit-print-color-adjust: exact;
                /* Force l'impression des couleurs de fond */
            }

            /* 3. Masquer l'interface inutile */
            .no-print,
            header,
            aside,
            #results-empty-state,
            .loading-overlay,
            #outdated-overlay,
            button {
                display: none !important;
            }

            .print-only {
                display: block !important;
            }

            /* 4. Ciblage chirurgical du panneau de résultats */
            main {
                display: block !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                height: 100% !important;
                position: relative !important;
            }

            #results-panel {
                display: block !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                padding: 1.5cm !important;
                /* Marges internes confortables */
                background: white !important;
            }

            #results-content {
                display: block !important;
                opacity: 1 !important;
                visibility: visible !important;
                width: 100% !important;
            }

            /* 5. Optimisation verticale (Compacter pour que ça rentre sans zoomer arrière) */
            .space-y-6> :not([hidden])~ :not([hidden]) {
                margin-top: 1.5rem !important;
                /* Espacement standard */
            }

            /* Réduire la taille du header PDF */
            #pdf-header {
                margin-bottom: 1rem !important;
                padding-bottom: 1rem !important;
            }

            #pdf-header h1 {
                font-size: 2rem !important;
            }

            /* Carte Hero (Fond coloré forcé) */
            .bg-slate-900 {
                background: #0F172A !important;
                /* Garder le bleu foncé à l'impression ! */
                color: white !important;
                border: none !important;
                padding: 1.5rem !important;
                border-radius: 1rem !important;
                margin-bottom: 1.5rem !important;
            }

            /* Exception pour le texte dans la carte foncée */
            .bg-slate-900 .text-slate-900 {
                color: white !important;
            }

            .bg-slate-900 h3,
            .bg-slate-900 p {
                color: white !important;
            }

            .bg-slate-900 .text-emerald-600 {
                color: #34D399 !important;
            }

            /* Vert plus clair sur fond sombre */

            /* Ajustement Grid */
            .grid-cols-1 {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 1rem !important;
            }

            /* Cartes Blanches */
            .bg-white {
                border: 1px solid #E2E8F0 !important;
                box-shadow: none !important;
                padding: 1rem !important;
            }

            /* Graphiques */
            canvas {
                max-height: 250px !important;
                width: 100% !important;
            }

            /* Titres */
            h3.text-lg {
                font-size: 1.2rem !important;
                margin-top: 1.5rem !important;
                margin-bottom: 1rem !important;
                color: #0F172A !important;
            }
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">

    <!-- TOP BAR -->
    <header
        class="h-16 bg-slate-900 text-white flex items-center justify-between px-6 z-20 shadow-lg no-print flex-shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center font-bold text-lg">K</div>
            <h1 class="font-bold text-lg tracking-wide">KOLILINK <span class="font-light text-slate-400">|
                    Simulateur</span></h1>
        </div>

        <!-- MODE SWITCHER (Choix de la vue) -->
        <div class="bg-slate-800 p-1 rounded-lg flex items-center gap-1">
            <button onclick="switchMode('1an')" id="btn-mode-1an"
                class="px-4 py-1.5 rounded-md text-sm font-medium transition-all bg-blue-600 text-white shadow">
Vue sur 1 an
            </button>
            <button onclick="switchMode('5ans')" id="btn-mode-5ans"
                class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-400 hover:text-white">
                Vue sur 5 ans
            </button>
        </div>

        <div class="flex items-center gap-4">
            <!-- Indicateur de sauvegarde DB -->
            <div id="db-status" class="text-xs font-mono text-slate-400 hidden md:block"></div>

            <button onclick="printReport()"
                class="bg-white text-slate-900 hover:bg-slate-100 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z">
                    </path>
                </svg>
                Imprimer
            </button>
        </div>
    </header>

    <!-- MAIN CONTENT GRID -->
    <div class="flex-grow flex flex-col md:flex-row overflow-hidden relative">

        <!-- LEFT SIDEBAR: CONFIGURATION (Stable) -->
        <aside
            class="w-full md:w-[400px] bg-slate-800 text-white flex flex-col border-r border-slate-700 z-10 overflow-y-auto no-print shadow-2xl">

            <div class="p-6 space-y-8 pb-24">

                <!-- Instruction -->
                <div class="bg-blue-900/40 border border-blue-700/50 rounded-lg p-3 text-xs text-blue-200 flex gap-2">
                    <svg class="w-4 h-4 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p>Entrez vos informations ci-dessous puis cliquez sur "Lancer la simulation".</p>
                </div>

                <!-- 1. IDENTIFICATION -->
                <div>
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-blue-500"></span> 1. Vos Informations
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Nom Université</label>
                            <input type="text" id="school-name" placeholder="Ex: Université de Labé"
                                class="input-dark w-full p-3 rounded-lg text-sm font-bold">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Effectif Total</label>
                            <input type="number" id="total-students" value="5000"
                                class="input-dark w-full p-3 rounded-lg text-sm font-mono tracking-wider">
                        </div>
                    </div>
                </div>

                <!-- 2. CONFIGURATEUR PRODUITS -->
                <div>
                    <div class="flex justify-between items-end mb-4">
                        <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-500"></span> 2. Produits
                        </h2>
                    </div>

                    <div class="space-y-3" id="product-config-container">
                        <!-- Products injected via JS -->
                    </div>
                </div>

            </div>

            <!-- BOUTON D'ACTION FLOTTANT (Sticky Bottom) -->
            <div
                class="absolute bottom-0 left-0 w-full md:w-[400px] p-4 bg-slate-900/95 border-t border-slate-700 backdrop-blur">
                <button onclick="runSimulation()" id="btn-calculate"
                    class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg shadow-blue-900/30 transition-all flex items-center justify-center gap-3 transform active:scale-95 btn-pulse ring-1 ring-white/10">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"></path>
                    </svg>
                    LANCER LA SIMULATION
                </button>
            </div>
        </aside>

        <!-- RIGHT MAIN: VISUALIZATION -->
        <main class="flex-grow bg-slate-50 relative overflow-y-auto p-4 md:p-8" id="results-panel">

            <!-- Loading Overlay -->
            <div id="loading-screen"
                class="absolute inset-0 loading-overlay hidden flex items-center justify-center flex-col">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
                <p class="text-slate-600 font-bold text-lg animate-pulse">Calcul des projections...</p>
                <p class="text-slate-400 text-sm mt-2">Sauvegarde vers la base de données...</p>
            </div>

            <!-- EMPTY STATE (Visible au démarrage) -->
            <div id="results-empty-state"
                class="h-full flex flex-col items-center justify-center text-center space-y-6 opacity-100 transition-opacity duration-500">
                <div class="w-24 h-24 bg-slate-200 rounded-full flex items-center justify-center animate-pulse">
                    <svg class="w-10 h-10 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                        </path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-slate-700">En attente de simulation</h3>
                    <p class="text-slate-500 max-w-sm mx-auto mt-2 text-sm">Pour voir l’impact, entrez les informations de votre établissement à gauche, puis cliquez sur <strong>"LANCER LA SIMULATION"</strong>
                        </p>
                </div>            </div>

            <!-- CONTENT WRAPPER (Masqué par défaut) -->
            <div id="results-content" class="hidden opacity-0 transition-opacity duration-500 relative min-h-full">

                <!-- Overlay "Données périmées" -->
                <div id="outdated-overlay"
                    class="absolute inset-0 bg-slate-50/50 backdrop-blur-[1px] z-40 hidden flex items-center justify-center pointer-events-none transition-opacity duration-300">
                    <div
                        class="bg-white/80 px-4 py-2 rounded-full shadow-sm text-slate-500 text-sm font-medium border border-slate-200">
                        Données modifiées • Cliquez sur "Actualiser"
                    </div>
                </div>

                <!-- PDF PRINT HEADER -->
                <div id="pdf-header" class="hidden print-only mb-4 pb-4 border-b-2 border-slate-900">
                    <h1 class="text-3xl font-bold text-slate-900 uppercase">Rapport de Simulation</h1>
                    <div class="flex justify-between items-end mt-2">
                        <h2 id="print-school-title" class="text-xl font-bold text-blue-600"></h2>
                        <p id="print-subtitle" class="text-sm text-slate-500"></p>
                    </div>
                </div>

                <!-- VUE 1 : TACTIQUE (1 AN) -->
                <div id="view-1an" class="max-w-5xl mx-auto space-y-6 transition-all duration-500">

                    <!-- HERO CARD (Adaptée pour print: fond sombre forcé via CSS print) -->
                    <div
                        class="bg-white rounded-2xl p-8 border border-slate-200 shadow-xl relative overflow-hidden group hover:border-blue-300 transition-colors print:bg-slate-900">
                        <div
                            class="absolute top-0 right-0 w-64 h-64 bg-orange-500/10 rounded-full blur-3xl -mr-16 -mt-16 transition-opacity opacity-100">
                        </div>

                        <div class="relative z-10 flex flex-col md:flex-row justify-between items-center gap-6">
                            <div class="text-center md:text-left print:text-white">
                                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-1">Profits Générés en 2026</h3>
                                <!-- Séparation visuelle nette Chiffre / Devise -->
                                <div class="flex items-baseline justify-center md:justify-start gap-3">
                                    <div class="text-5xl font-bold text-slate-900 font-display tracking-tight print:text-white"
                                        id="total-1an">0</div>
                                    <span class="text-2xl font-medium text-slate-400">GNF</span>
                                </div>
                                <p class="text-sm text-emerald-600 font-medium mt-2 print:text-emerald-400">Fonds d’urgence disponibles
</p>
                            </div>
                            <!-- Donut Chart -->
                            <div class="w-32 h-32 relative">
                                <canvas id="allocationChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- IMPACT GRID -->
                    <h3 class="text-lg font-bold text-slate-700 mt-8 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                       Plan d’urgence
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Card 1 -->
                        <div
                            class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm hover:shadow-lg transition-shadow">
                            <div class="flex justify-between items-start mb-4">
                                <div
                                    class="w-10 h-10 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                        </path>
                                    </svg>
                                </div>
                                <span class="text-xs font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded">40%</span>
                            </div>
                            <h4 class="font-bold text-slate-800">Ventilation</h4>
                            <p class="text-xs text-slate-400 mb-3">Confort des salles</p>
                            <div class="text-2xl font-bold text-blue-600 mb-2" id="val-fans">0</div>
                            <p class="text-xs text-slate-400">Budget</p>
                        </div>

                        <!-- Card 2 -->
                        <div
                            class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm hover:shadow-lg transition-shadow">
                            <div class="flex justify-between items-start mb-4">
                                <div
                                    class="w-10 h-10 rounded-lg bg-orange-50 text-orange-600 flex items-center justify-center">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z">
                                        </path>
                                    </svg>
                                </div>
                                <span class="text-xs font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded">40%</span>
                            </div>
                            <h4 class="font-bold text-slate-800">Sanitaires</h4>
                            <p class="text-xs text-slate-400 mb-3">Réparer les Toilettes</p>
                            <div class="text-lg font-bold text-orange-600 mb-2" id="val-toilets">0 GNF</div>
                            <p class="text-xs text-slate-400">Budget</p>
                        </div>

                        <!-- Card 3 -->
                        <div
                            class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm hover:shadow-lg transition-shadow">
                            <div class="flex justify-between items-start mb-4">
                                <div
                                    class="w-10 h-10 rounded-lg bg-red-50 text-red-600 flex items-center justify-center">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z">
                                        </path>
                                    </svg>
                                </div>
                                <span class="text-xs font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded">20%</span>
                            </div>
                            <h4 class="font-bold text-slate-800">Santé</h4>
                            <p class="text-xs text-slate-400 mb-3">Kits Urgence Infirmerie</p>
                            <div class="text-lg font-bold text-red-600 mb-2" id="val-health">0 GNF</div>
                            <p class="text-xs text-slate-400">Budget</p>
                        </div>
                    </div>
                </div>

                <!-- VUE 2 : STRATÉGIE (5 ANS) -->
                <div id="view-5ans"
                    class="max-w-5xl mx-auto space-y-6 hidden opacity-0 transition-all duration-500 transform translate-y-4">

                    <!-- HERO CARD 5Y -->
                    <div
                        class="bg-slate-900 rounded-2xl p-8 text-white relative overflow-hidden shadow-2xl print:bg-slate-900">
                        <div
                            class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-20">
                        </div>
                        <div
                            class="absolute top-0 right-0 w-96 h-96 bg-blue-600 rounded-full blur-[100px] opacity-20 -mr-20 -mt-20">
                        </div>

                        <div class="relative z-10 text-center">
                            <h3 class="text-sm font-bold text-blue-400 uppercase tracking-widest mb-2 print:text-white">
                                Potentiel de Transformation (2026-2031)</h3>
                            <!-- Séparation Chiffre / Devise pour 5 ans -->
                            <div class="flex items-baseline justify-center gap-3 mb-4">
                                <div class="text-5xl md:text-7xl font-extrabold tracking-tight font-display print:text-white"
                                    id="total-5ans">0</div>
                                <span class="text-3xl font-medium text-slate-500 print:text-slate-300">GNF</span>
                            </div>
                            <p class="text-slate-400 max-w-lg mx-auto print:text-slate-300">Capital cumulé pour
                                l'autonomie totale (Bus, Bâtiments, IA).</p>
                        </div>
                    </div>

                    <!-- CHART AREA -->
                    <div class="bg-white rounded-2xl p-6 border border-slate-200 shadow-lg">
                        <h3 class="text-lg font-bold text-slate-700 mb-6 flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z">
                                </path>
                            </svg>
                            Trajectoire de Croissance
                        </h3>
                        <div class="w-full h-[300px]">
                            <canvas id="growthChart"></canvas>
                        </div>
                    </div>

                    <!-- ROADMAP -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div
                            class="p-6 bg-white rounded-xl border-l-4 border-blue-500 shadow-sm hover:translate-x-1 transition-transform">
                            <span class="text-xs font-bold text-blue-500 uppercase">Horizon 1-2 Ans</span>
                            <h4 class="font-bold text-lg text-slate-800 mt-1">Infrastructures</h4>
                            <p class="text-sm text-slate-500 mt-1">Rénovations, Mobilier</p>
                        </div>
                        <div
                            class="p-6 bg-white rounded-xl border-l-4 border-purple-500 shadow-sm hover:translate-x-1 transition-transform">
                            <span class="text-xs font-bold text-purple-500 uppercase">Horizon 3-4 Ans</span>
                            <h4 class="font-bold text-lg text-slate-800 mt-1">Digitalisation</h4>
                            <p class="text-sm text-slate-500 mt-1">Wi-Fi, Parc Informatique</p>
                        </div>
                        <div
                            class="p-6 bg-white rounded-xl border-l-4 border-emerald-500 shadow-sm hover:translate-x-1 transition-transform">
                            <span class="text-xs font-bold text-emerald-500 uppercase">Horizon 5 Ans</span>
                            <h4 class="font-bold text-lg text-slate-800 mt-1">Autonomie</h4>
                            <p class="text-sm text-slate-500 mt-1">Bus, Nouveaux Bâtiments</p>
                        </div>
                    </div>
                </div>

            </div>

        </main>
    </div>

    <script>
        // --- 1. DATA & STATE ---
        let currentMode = '1an';
        let growthChartInstance = null;
        let allocationChartInstance = null;

        const defaultProducts = [
            { id: 'bloc250', name: 'Bloc Note 250p', price: 15000, cost: 12000, qty: 1, active: true },
            { id: 'cahier100', name: 'Cahier 100p', price: 6000, cost: 5500, qty: 4, active: true },
            { id: 'cahier200', name: 'Cahier 200p', price: 10000, cost: 7000, qty: 2, active: true },
            { id: 'bic', name: 'Stylo Bic', price: 1000, cost: 500, qty: 4, active: true },
            { id: 'maillot', name: 'Maillot Sport', price: 50000, cost: 45000, qty: 1, active: true },
            { id: 'sac', name: 'Sac à Dos', price: 60000, cost: 45000, qty: 1, active: true }
        ];

        // --- 2. UTILS ---
        // Helper pour formater uniquement le nombre avec espaces (ex: 10 000 000)
        const formatNumber = (val) => new Intl.NumberFormat('fr-FR').format(val);
        const formatGNF = (val) => formatNumber(val) + ' GNF';

        function animateValue(id, end, type = 'currency') {
            const obj = document.getElementById(id);
            if (!obj) return;
            const start = parseInt(obj.innerText.replace(/[^0-9]/g, '')) || 0;
            if (start === end) return;

            const duration = 1000;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const ease = 1 - Math.pow(1 - progress, 4);

                const current = Math.floor(start + (end - start) * ease);

                // Gestion de l'affichage : Soit GNF collé, soit Nombre seul (pour le nouveau design)
                if (type === 'currency') obj.innerText = formatGNF(current);
                else if (type === 'formatted') obj.innerText = formatNumber(current);
                else obj.innerText = current; // Raw number

                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }

        // --- 3. UI BUILDER ---
        function initProductConfig() {
            const container = document.getElementById('product-config-container');
            container.innerHTML = '';

            defaultProducts.forEach(p => {
                const item = document.createElement('div');
                item.className = "bg-slate-700/50 p-3 rounded-lg border border-slate-600 flex items-center gap-3 hover:border-blue-500 transition-colors";
                item.innerHTML = `
                    <div class="flex items-center h-full">
                        <input type="checkbox" id="check-${p.id}" ${p.active ? 'checked' : ''} class="w-4 h-4 rounded border-gray-500 text-blue-600 focus:ring-blue-500 bg-gray-700 cursor-pointer">
                    </div>
                    <div class="flex-grow min-w-0">
                        <p class="text-xs font-bold text-slate-200 truncate">${p.name}</p>
                        <p class="text-[10px] text-slate-400">Coût: ${p.cost}</p>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex flex-col w-20">
                            <label class="text-[9px] text-slate-500">Prix Vente</label>
                            <input type="number" id="price-${p.id}" value="${p.price}" class="bg-slate-800 border border-slate-600 text-white text-xs rounded px-2 py-1 text-right focus:border-blue-500 outline-none input-watch">
                        </div>
                        <div class="flex flex-col w-12">
                            <label class="text-[9px] text-slate-500">Qté</label>
                            <input type="number" id="qty-${p.id}" value="${p.qty}" class="bg-slate-800 border border-slate-600 text-white text-xs rounded px-2 py-1 text-center focus:border-blue-500 outline-none input-watch">
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // --- 4. MODE SWITCHER ---
        function switchMode(mode) {
            currentMode = mode;
            const btn1 = document.getElementById('btn-mode-1an');
            const btn5 = document.getElementById('btn-mode-5ans');
            const view1 = document.getElementById('view-1an');
            const view5 = document.getElementById('view-5ans');

            if (mode === '1an') {
                btn1.className = "px-4 py-1.5 rounded-md text-sm font-medium transition-all bg-blue-600 text-white shadow transform scale-105";
                btn5.className = "px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-400 hover:text-white";

                view1.classList.remove('hidden');
                setTimeout(() => view1.classList.remove('opacity-0', 'translate-y-4'), 50);

                view5.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => view5.classList.add('hidden'), 300);
            } else {
                btn5.className = "px-4 py-1.5 rounded-md text-sm font-medium transition-all bg-blue-600 text-white shadow transform scale-105";
                btn1.className = "px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-400 hover:text-white";

                view5.classList.remove('hidden');
                setTimeout(() => view5.classList.remove('opacity-0', 'translate-y-4'), 50);

                view1.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => view1.classList.add('hidden'), 300);
            }
        }

        // --- 5. LOGIQUE DE CALCUL ---
        function markAsDirty() {
            const btn = document.getElementById('btn-calculate');
            const content = document.getElementById('results-content');
            const overlay = document.getElementById('outdated-overlay');

            btn.classList.add('bg-orange-600', 'hover:bg-orange-500', 'ring-orange-400');
            btn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
            btn.innerText = "ACTUALISER LA SIMULATION";

            if (content && !content.classList.contains('hidden')) {
                overlay.classList.remove('hidden');
            }
        }

        document.addEventListener('input', (e) => {
            if (e.target.closest('aside')) {
                markAsDirty();
            }
        });

        function runSimulation() {
            const btn = document.getElementById('btn-calculate');
            const overlay = document.getElementById('loading-screen');
            const outdated = document.getElementById('outdated-overlay');
            const emptyState = document.getElementById('results-empty-state');
            const content = document.getElementById('results-content');
            const schoolName = document.getElementById('school-name').value;

            btn.classList.remove('bg-orange-600', 'hover:bg-orange-500', 'ring-orange-400');
            btn.classList.add('bg-blue-600', 'hover:bg-blue-500');

            const originalText = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"></path></svg> LANCER LA SIMULATION`;

            btn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Calcul en cours...`;
            btn.disabled = true;
            overlay.classList.remove('hidden');
            if (outdated) outdated.classList.add('hidden');

            setTimeout(() => {
                const results = performCalculation();

                // Hide empty state and show content
                emptyState.classList.add('hidden');
                content.classList.remove('hidden');
                requestAnimationFrame(() => content.classList.remove('opacity-0'));

                btn.innerHTML = originalText;
                btn.disabled = false;
                overlay.classList.add('hidden');

                if (window.innerWidth < 768) {
                    document.getElementById('results-panel').scrollIntoView({ behavior: 'smooth' });
                }

                // Sauvegarde DB
                saveDataToDB(schoolName, results);

            }, 800);
        }

        function performCalculation() {
            let marginPerKit = 0;
            const activeProducts = [];

            defaultProducts.forEach(p => {
                const check = document.getElementById(`check-${p.id}`);
                if (!check || !check.checked) return;

                const priceInput = document.getElementById(`price-${p.id}`);
                const qtyInput = document.getElementById(`qty-${p.id}`);

                const price = parseFloat(priceInput.value) || 0;
                const qty = parseFloat(qtyInput.value) || 0;

                marginPerKit += (price - p.cost) * qty;

                activeProducts.push({
                    name: p.name,
                    price: price,
                    qty: qty,
                    margin: (price - p.cost) * qty
                });
            });

            const students = parseFloat(document.getElementById('total-students').value) || 0;
            const annualTotal = students * marginPerKit;
            const total5y = annualTotal * 5;

            // Utilisation du mode 'formatted' pour n'afficher que le chiffre avec espaces
            animateValue('total-1an', annualTotal, 'formatted');

            const fanBudget = annualTotal * 0.4;
            const toiletBudget = annualTotal * 0.4;
            const healthBudget = annualTotal * 0.2;
            const fanCount = Math.floor(fanBudget / 450000);

            // Afficher le budget alloué (currency) au lieu du nombre (false)
            animateValue('val-fans', fanBudget, 'currency');
            animateValue('val-toilets', toiletBudget, 'currency');
            animateValue('val-health', healthBudget, 'currency');

            updateAllocationChart(fanBudget, toiletBudget, healthBudget);

            // Pour 5 ans, on affiche aussi le chiffre formaté seul (car GNF est dans le HTML)
            animateValue('total-5ans', total5y, 'formatted');
            updateGrowthChart(annualTotal);

            // Retourne les données pour la sauvegarde
            return {
                annualTotal,
                total5y,
                marginPerKit,
                activeProducts
            };
        }

        // --- 6. CHARTS ---
        function updateAllocationChart(fans, toilets, health) {
            const ctx = document.getElementById('allocationChart').getContext('2d');
            if (allocationChartInstance) allocationChartInstance.destroy();

            allocationChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ventilation', 'Sanitaires', 'Santé'],
                    datasets: [{
                        data: [fans, toilets, health],
                        backgroundColor: ['#3B82F6', '#F97316', '#EF4444'],
                        borderWidth: 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    cutout: '70%',
                    animation: { animateScale: true, animateRotate: true }
                }
            });
        }

        function updateGrowthChart(annual) {
            const ctx = document.getElementById('growthChart').getContext('2d');
            const dataPoints = [annual, annual * 2, annual * 3, annual * 4, annual * 5];

            if (growthChartInstance) {
                growthChartInstance.data.datasets[0].data = dataPoints;
                growthChartInstance.update();
            } else {
                growthChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Année 1', 'Année 2', 'Année 3', 'Année 4', 'Année 5'],
                        datasets: [{
                            label: 'Capital Cumulé',
                            data: dataPoints,
                            borderColor: '#3B82F6',
                            backgroundColor: (context) => {
                                const ctx = context.chart.ctx;
                                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                                gradient.addColorStop(0, 'rgba(59, 130, 246, 0.2)');
                                gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
                                return gradient;
                            },
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#3B82F6',
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: '#E2E8F0' } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }
        }

        // --- 7. PRINT ---
        function printReport() {
            const school = document.getElementById('school-name').value || "Université";
            document.getElementById('print-school-title').innerText = school;

            const subtitle = currentMode === '1an'
                ? "Plan d'Urgence Immédiat (Focus Rentrée)"
                : "Plan Stratégique Quinquennal (Vision Long Terme)";
            document.getElementById('print-subtitle').innerText = subtitle;

            if (currentMode === '1an') {
                document.getElementById('view-5ans').classList.add('no-print');
                document.getElementById('view-1an').classList.remove('no-print');
            } else {
                document.getElementById('view-1an').classList.add('no-print');
                document.getElementById('view-5ans').classList.remove('no-print');
            }

            window.print();
        }

        // --- 8. SUPABASE CONNECTION & SAVE ---
        const SUPABASE_URL = "https://kgqjgoauhwqhtfavfhpk.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtncWpnb2F1aHdxaHRmYXZmaHBrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4ODgwMjgsImV4cCI6MjA3NzQ2NDAyOH0.D3KIZI9--Y-V7Ms0dygbqLXAZWANMLjtn_NFJAb6mBA";
        let supabaseClient = null;
        try { if (window.supabase) supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch (e) { }

        async function saveDataToDB(schoolName, data) {
            if (!supabaseClient) {
                console.error("Supabase client not initialized");
                return;
            }

            if (!schoolName) schoolName = "Université Inconnue";

            // Mapping exact avec la table SQL : simulations_universite
            // MODIFICATION: Suppression de la colonne 'details' pour éviter l'erreur de schéma
            const dbPayload = {
                nom_ecole: schoolName,
                marge_globale_universite: data.annualTotal
            };

            const statusEl = document.getElementById('db-status');
            if (statusEl) statusEl.innerText = "Sauvegarde...";

            try {
                const { error } = await supabaseClient
                    .from('simulations_universite')
                    .insert(dbPayload);

                if (error) {
                    console.error("DB Error:", error);
                    // Fallback visual feedback even on error if it's just a schema issue
                    if (statusEl) statusEl.innerText = "Sauvegarde locale OK (DB Error)";
                } else {
                    if (statusEl) {
                        statusEl.innerText = "Sauvegardé ✓";
                        statusEl.classList.add('text-emerald-500');
                        setTimeout(() => statusEl.classList.remove('text-emerald-500'), 3000);
                    }
                }
            } catch (e) {
                console.error("Exception:", e);
            }
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            initProductConfig();
        });

    </script>
</body>


</html>






